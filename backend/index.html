<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>ğŸ³ é€²éšå¤šé£Ÿæé£Ÿè­œåŠ©æ‰‹</title>
    <style>
        :root { --primary: #ff6b6b; --secondary: #4ecdc4; --accent: #ff9f43; --bg: #f7f9fc; }
        body { font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 900px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: var(--primary); }
        
        .section { background: #fff; border: 1px solid #eee; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .random-section { background: #fff4e6; border: 2px dashed var(--accent); text-align: center; }
        
        /* æœå°‹å€å¡Šæ¨£å¼ */
        .search-controls { display: flex; flex-direction: column; gap: 15px; }
        .input-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        input, select { padding: 10px; border: 2px solid #ddd; border-radius: 8px; outline: none; width: 140px;}
        
        button { padding: 10px 20px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        button:hover { opacity: 0.8; }
        .btn-add { background: var(--secondary); margin-top: 5px; }
        .btn-search { background: var(--primary); font-size: 1.1em; width: 100%; }

        /* å¡ç‰‡èˆ‡æ¨™ç±¤æ¨£å¼ */
        .recipe-card { background: #fff; border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 12px; }
        .recipe-header { display: flex; justify-content: space-between; align-items: center; }
        .tag { background: var(--secondary); color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.8em; margin-left: 10px; }
        .tag-dessert { background-color: #f1a2d0 !important; } /* ç”œé»ç²‰è‰² */

        .content-label { font-weight: bold; color: var(--primary); margin-top: 15px; display: block; border-left: 4px solid var(--primary); padding-left: 8px; }
        .steps-text { white-space: pre-wrap; background: #f9f9f9; padding: 10px; border-radius: 8px; margin-top: 5px; line-height: 1.6; }
        
        .fav-btn { background: none; color: #ccc; font-size: 28px; border: none; cursor: pointer; transition: 0.2s; }
        .fav-btn.active { color: var(--primary); }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ³ é€²éšå¤šé£Ÿæé£Ÿè­œåŠ©æ‰‹</h1>

    <div class="section random-section">
        <button style="background: var(--accent);" onclick="getRandomRecipe()">ğŸ² éš¨æ©ŸæŠ½ä¸€é“èœï¼</button>
        <div id="random-display" style="margin-top: 15px;"></div>
    </div>
    
    <div class="section">
        <div class="search-controls">
            <div class="input-group">
                <label>é¸æ“‡æ¨¡å¼ï¼š</label>
                <select id="search-mode" onchange="toggleInputMode()">
                    <option value="all">æ‰€æœ‰åˆ†é¡æœå°‹</option>
                    <option value="home">ğŸ  å®¶å¸¸èœæœå°‹</option>
                    <option value="dessert">ğŸ° ç”œé»æœå°‹</option>
                    <option value="name">ğŸ” ä¾é£Ÿè­œåç¨±</option>
                    <option value="favorite">â¤ï¸ æˆ‘çš„æ”¶è—</option>
                </select>
            </div>

            <div id="ingredients-container">
                <div class="input-group" id="ingredients-inputs">
                    <input name="ingredient" placeholder="è¼¸å…¥é£Ÿæ (ä¾‹: è›‹)">
                </div>
                <div style="margin-top: 10px; display: flex; gap: 10px;"></div>
                <button type="button" class="btn-add" id="add-btn"    onclick="addIngredient()"    style="background-color: #6d80b2;">ï¼‹ æ–°å¢é£Ÿææ¬„ä½</button>
                <button type="button"                 id="remove-btn" onclick="removeIngredient()" style="background-color: #baa864;">ï¼ æ¸›å°‘é£Ÿææ¬„ä½</button>
            </div>
            
            <button class="btn-search" onclick="search()">ç«‹å³æŸ¥è©¢å¥½æ–™</button>
        </div>
    </div>

    <div id="recipe-list"></div>
</div>

<script>
    const API_BASE = window.location.hostname === "127.0.0.1" || window.location.hostname === "localhost"? "http://127.0.0.1:8000"
        : "https://127.0.0.1:8000.zeabur.app";

    // å‹•æ…‹æ–°å¢è¼¸å…¥æ¡†
   // å‹•æ…‹æ–°å¢è¼¸å…¥æ¡† (é™åˆ¶ç¸½æ•¸ä¸è¶…é 5 å€‹)

function addIngredient() {
    const container = document.getElementById("ingredients-inputs");
    const currentInputs = document.getElementsByName("ingredient");
    // æœ¨èƒ½è¶…é5å€‹æ¬„ä½
    if (currentInputs.length < 5) {
        const input = document.createElement("input");
        input.name = "ingredient";
        input.placeholder = "è¼¸å…¥é£Ÿæ";
        input.style.marginTop = "5px";
        container.appendChild(input);
    }
    checkInputLimit();
}

// ç§»é™¤æœ€å¾Œä¸€å€‹é£Ÿææ¬„ä½
function removeIngredient() {
    const container = document.getElementById("ingredients-inputs");
    const currentInputs = document.getElementsByName("ingredient");

    // è‡³å°‘ä¿ç•™ä¸€å€‹æ¬„ä½
    if (currentInputs.length > 1) {
        container.removeChild(container.lastChild);
    } 
    checkInputLimit();
    search(); // ç§»é™¤å¾Œè‡ªå‹•é‡æ–°æœå°‹ï¼Œä¿æŒçµæœåŒæ­¥
}

// æª¢æŸ¥è¼¸å…¥æ¡†æ•¸é‡ä¸¦æ§åˆ¶æŒ‰éˆ•ç‹€æ…‹
function checkInputLimit() {
    const addBtn = document.getElementById("add-btn");
    const removeBtn = document.getElementById("remove-btn");
    const currentInputs = document.getElementsByName("ingredient");
    const count = currentInputs.length;

    // --- æª¢æŸ¥ã€Œæ–°å¢ã€æŒ‰éˆ• (ä¸Šé™ 5) ---
    if (currentInputs.length >= 5) {
        // è®Šæš—ä¸¦ç¦ç”¨
        addBtn.disabled = true;
        addBtn.style.backgroundColor = "#ccc"; // è®Šæš—
        addBtn.style.cursor = "not-allowed";   // ç¦æ­¢è§¸ç™¼
        addBtn.innerText = "å·²é” 5 å€‹ä¸Šé™";
    } else {
        // æ¢å¾©åŸç‹€ (é’ç¶ è‰²)
        addBtn.disabled = false;
        addBtn.style.backgroundColor = "#6d80b2"; // æ¢å¾©æ·±é¡è‰²
        addBtn.style.cursor = "pointer";
        addBtn.innerText = "ï¼‹ æ–°å¢é£Ÿææ¬„ä½";
    }
    // --- æª¢æŸ¥ã€Œæ¸›å°‘ã€æŒ‰éˆ• (ä¸‹é™ 1) ---
    if (count <= 1) {
        // è®Šæš—ä¸¦ç¦ç”¨
        removeBtn.disabled = true;
        removeBtn.style.backgroundColor = "#ccc"; // è®Šæš—
        removeBtn.style.cursor = "not-allowed";   // ç¦æ­¢è§¸ç™¼
        removeBtn.innerText = "æœ€å°‘ä¿ç•™ä¸€æ¬„";
    } else {
        // æ¢å¾©åŸç‹€ ()
        removeBtn.disabled = false;
        removeBtn.style.backgroundColor = "#baa864"; // æ¢å¾©æ·±é¡è‰²
        removeBtn.style.cursor = "pointer";
        removeBtn.innerText = "ï¼ æ¸›å°‘é£Ÿææ¬„ä½";
    }

    
}



    // ä¾æ¨¡å¼åˆ‡æ›é¡¯ç¤º (åç¨±æ¨¡å¼ä¸é¡¯ç¤ºã€Œæ–°å¢é£Ÿæã€)
function toggleInputMode() {
    const mode = document.getElementById('search-mode').value;
    const addBtn = document.getElementById('add-btn');      // å–å¾—å¢åŠ æŒ‰éˆ•
    const removeBtn = document.getElementById('remove-btn'); // å–å¾—æ¸›å°‘æŒ‰éˆ•
    const inputs = document.getElementsByName('ingredient');
    
    if (mode === 'name' || mode === 'favorite') {
        addBtn.style.display = 'none';          // éš±è—æ–°å¢æŒ‰éˆ•
        removeBtn.style.display = 'none';       // éš±è—æ¸›å°‘æŒ‰éˆ•
        inputs[0].placeholder = "è¼¸å…¥é£Ÿè­œåç¨±";
        while(inputs.length > 1) inputs[1].remove();
    } else {
        addBtn.style.display = 'inline-block';
        removeBtn.style.display = 'inline-block';
        inputs[0].placeholder = "è¼¸å…¥é£Ÿæ (ä¾‹: è›‹)";
    }
    
    // é‡ç½®å¾Œæª¢æŸ¥ä¸€æ¬¡æŒ‰éˆ•ç‹€æ…‹
    checkInputLimit();
    search();
}

    async function search() {
        const mode = document.getElementById('search-mode').value;
        const inputs = document.getElementsByName('ingredient');
        const listDiv = document.getElementById('recipe-list');
        listDiv.innerHTML = "ğŸ” æœå°‹ä¸­...";

        let url;
        if (mode === 'favorite') {
            url = `${API_BASE}/favorite`;
        } else if (mode === 'name') {
            const val = inputs[0].value.trim();
            url = val ? `${API_BASE}/detail?name=${encodeURIComponent(val)}` : `${API_BASE}/list`;
        } else {
            // å¤šé£Ÿææ¨¡å¼ï¼šæ§‹å»º URL åƒæ•¸
            url = `${API_BASE}/search?`;
            if (mode !== 'all') url += `category=${mode}&`;
            
            // æŠ“å–æ‰€æœ‰ input çš„å€¼ä¸¦æ‹¼æ¥åˆ° URL
            for (let input of inputs) {
                if (input.value.trim()) {
                    url += `ingredient=${encodeURIComponent(input.value.trim())}&`;
                }
            }
        }

        try {
            const res = await fetch(url);
            const data = await res.json();
            let results = data.results || data.recipes || data.favorites || (data.name ? [data] : []);
            
            // å¦‚æœæ˜¯åœ¨æ”¶è—æ¨¡å¼ä¸‹æœå°‹é—œéµå­—
            if (mode === 'favorite' && inputs[0].value.trim()) {
                results = results.filter(r => r.name.includes(inputs[0].value.trim()));
            }
            renderRecipes(results, 'recipe-list');
        } catch (e) {
            listDiv.innerHTML = "âŒ ç„¡æ³•é€£ç·šè‡³å¾Œç«¯";
        }
    }

    function renderRecipes(recipes, targetId) {
        const targetDiv = document.getElementById(targetId);
        if (!recipes || recipes.length === 0 || recipes[0].error) {
            targetDiv.innerHTML = "<p style='text-align:center;'>æ‰¾ä¸åˆ°ç›¸é—œé£Ÿè­œï¼Œæ›å€‹é—œéµå­—è©¦è©¦ï¼</p>";
            return;
        }

        targetDiv.innerHTML = recipes.map(r => {
            const isDessert = r.category && (r.category.includes("ç”œé»") || r.category.toLowerCase().includes("dessert"));
            const tagClass = isDessert ? 'tag tag-dessert' : 'tag';
            return `
                <div class="recipe-card">
                    <div class="recipe-header">
                        <h3 style="margin:0;">${r.name} <span class="${tagClass}">${r.category}</span></h3>
                        <button class="fav-btn ${r.is_favorite ? 'active' : ''}" 
                                onclick="toggleFavorite('${r.name}', ${r.is_favorite})">â¤</button>
                    </div>
                    <span class="content-label">ğŸ›’ æº–å‚™é£Ÿæ</span>
                    <p>${r.ingredients ? r.ingredients.join('ã€') : ''}</p>
                    <span class="content-label">ğŸ‘¨â€ğŸ³ æ–™ç†æ­¥é©Ÿ</span>
                    <div class="steps-text">${r.steps || 'æš«ç„¡æ­¥é©Ÿ'}</div>
                </div>
            `;
        }).join('');
    }

    async function toggleFavorite(name, isFav) {
        const method = isFav ? 'DELETE' : 'POST';
        await fetch(`${API_BASE}/favorite?name=${encodeURIComponent(name)}`, { method: method });
        
        // å…¨åŸŸåˆ·æ–°
        search();
        
        // å¦‚æœéš¨æ©Ÿå€æ­£é¡¯ç¤ºè©²é£Ÿè­œï¼ŒåŒæ­¥å®ƒ
        const randomDiv = document.getElementById('random-display');
        if (randomDiv.innerHTML.includes(name)) {
            const res = await fetch(`${API_BASE}/detail?name=${encodeURIComponent(name)}`);
            const updated = await res.json();
            renderRecipes([updated], 'random-display');
        }
    }

    async function getRandomRecipe() {
        const res = await fetch(`${API_BASE}/random`);
        const data = await res.json();
        renderRecipes([data], 'random-display');
    }

    window.onload = search;
</script>
</body>
</html>




